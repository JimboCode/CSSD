package UI;

import BLL.Client;
import BLL.ClientRegister;
import BLL.Project;
import BLL.ProjectRegister;
import BLL.Region;
import BLL.Staff;
import BLL.Worker;
import java.awt.Color;
import java.beans.PropertyVetoException;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Observable;
import java.util.Observer;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultComboBoxModel;
import javax.swing.JOptionPane;
import javax.swing.UIManager;
import javax.swing.event.CaretEvent;
import javax.swing.event.CaretListener;
import javax.swing.text.DateFormatter;
import javax.swing.text.MaskFormatter;

/**
 * Creates new media projects
 * 
 * @author James Staite
 * @version 1.0.0
 */
public class CreateProjectUI extends javax.swing.JInternalFrame implements Observer
{
    // Reference to user from Main UI
    private Worker user;
    
    // Reference to main UI
    private MainMDIUI mainform;
    
    /**
     * Creates new form CreateProjectUI
     */
    public CreateProjectUI(Worker user, MainMDIUI mainform)
    {
        super("Create New Project Details",false,true,false,false);
        initComponents();
        
        // hold reference to main UI
        this.mainform = mainform;
        
        // set default button
        this.getRootPane().setDefaultButton(btnDefineTeam);
        
        // load region combox with region information
        DefaultComboBoxModel regionComboModel = new DefaultComboBoxModel();
        for(Region region: Region.values())
        {
            regionComboModel.addElement(region);
        }
        cmbRegion.setModel(regionComboModel);
        
        ClientRegister clientReg = ClientRegister.getInstance();
        loadClientCombo(clientReg);
        
        // Set default date tomorrow
        Date today = new Date();        
        Date date = new Date(today.getTime() + (1000 * 60 * 60 * 24));
        ftxtCompletionDate.setValue(date);
        
        // set Managers Details
        txtManager.setText(user.getName());
        this.user = user;
        
        // setup validation action listner events for required fields
        txtProjectName.addCaretListener(new CaretListener() 
        {
            @Override
            public void caretUpdate(CaretEvent e) 
            {
                validiateForm();
            }
        });
        
        txtDiscTitle.addCaretListener(new CaretListener() 
        {
            @Override
            public void caretUpdate(CaretEvent e) 
            {
                validiateForm();
            }
        });
        
        ftxtCompletionDate.addCaretListener(new CaretListener() 
        {
            @Override
            public void caretUpdate(CaretEvent e) 
            {
                validiateForm();
            }
        });
        
        // register for BLL events
        registerEvents();
    }
    
    /**
     * Loads clients into the client combo box
     * @param clientReg Reference to the ClientRegister
     */
    private void loadClientCombo(ClientRegister clientReg)
    {
        // load client combox with client details
        DefaultComboBoxModel clientComboModel = new DefaultComboBoxModel();
        
        // load model with clients
        for(Client client: clientReg.getClientList())
        {
            clientComboModel.addElement(client);
        }
        
        // set combo to new model
        cmbClient.setModel(clientComboModel);
    }
    
    /*
     * registers for update events to the ClientRegister
     */
    private void registerEvents()
    {
        // get reference to client register and register for events
        ClientRegister clientReg = ClientRegister.getInstance();
        clientReg.addObserver(this);
    }
    
    private void deregisterEvents()
    {
        // get reference to client register and register for events
        ClientRegister clientReg = ClientRegister.getInstance();
        clientReg.deleteObserver(this);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lblProjectName = new javax.swing.JLabel();
        txtProjectName = new javax.swing.JTextField();
        lblDiscTitle = new javax.swing.JLabel();
        txtDiscTitle = new javax.swing.JTextField();
        lblDiscRegion = new javax.swing.JLabel();
        btnCreateProject = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();
        btnDefineTeam = new javax.swing.JButton();
        cmbRegion = new javax.swing.JComboBox();
        DateFormat format = new SimpleDateFormat("dd/MM/yyyy");
        DateFormatter df = new DateFormatter(format);
        ftxtCompletionDate = new javax.swing.JFormattedTextField(df);
        lblCompletionDate = new javax.swing.JLabel();
        lblManager = new javax.swing.JLabel();
        txtManager = new javax.swing.JTextField();
        lblClient = new javax.swing.JLabel();
        cmbClient = new javax.swing.JComboBox();

        setTitle("Create Project");

        lblProjectName.setText("Project Name");

        lblDiscTitle.setText("Disc Title");

        lblDiscRegion.setText("Disc Region");

        btnCreateProject.setText("Create Project");
        btnCreateProject.setEnabled(false);
        btnCreateProject.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCreateProjectActionPerformed(evt);
            }
        });

        btnCancel.setText("Cancel");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        btnDefineTeam.setText("Define Project Team");
        btnDefineTeam.setEnabled(false);
        btnDefineTeam.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDefineTeamActionPerformed(evt);
            }
        });

        cmbRegion.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));

        try
        {
            MaskFormatter dateMask = new MaskFormatter("##/##/####");
            dateMask.install(ftxtCompletionDate);
        } catch (ParseException ex)
        {
            Logger.getLogger(CreateProjectUI.class.getName()).log(Level.SEVERE, null, ex);
        }

        lblCompletionDate.setText("Completion Date");

        lblManager.setText("Manager");

        txtManager.setEditable(false);
        txtManager.setEnabled(false);

        lblClient.setText("Client");

        cmbClient.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGap(0, 195, Short.MAX_VALUE)
                        .addComponent(btnCancel)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnDefineTeam)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnCreateProject))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(lblProjectName)
                            .addComponent(lblDiscTitle)
                            .addComponent(lblDiscRegion)
                            .addComponent(lblCompletionDate)
                            .addComponent(lblManager)
                            .addComponent(lblClient))
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(txtProjectName)
                            .addComponent(txtDiscTitle)
                            .addComponent(txtManager)
                            .addComponent(cmbRegion, 0, 277, Short.MAX_VALUE)
                            .addComponent(ftxtCompletionDate, javax.swing.GroupLayout.PREFERRED_SIZE, 123, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(cmbClient, 0, 407, Short.MAX_VALUE))
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblClient)
                    .addComponent(cmbClient, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(8, 8, 8)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProjectName)
                    .addComponent(txtProjectName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 16, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblDiscTitle)
                    .addComponent(txtDiscTitle, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 16, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(cmbRegion, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblDiscRegion))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(ftxtCompletionDate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblCompletionDate))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblManager)
                    .addComponent(txtManager, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(16, 16, 16)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnCreateProject)
                    .addComponent(btnCancel)
                    .addComponent(btnDefineTeam))
                .addGap(19, 19, 19))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    /**
     * Closes the form
     * @param evt event argument
     */
    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
        //remove events
        deregisterEvents();
        // close form
        try {
            this.setClosed(true);
        } catch (PropertyVetoException ex) {
            Logger.getLogger(CreateClientUI.class.getName()).log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_btnCancelActionPerformed

    /**
     * Creates the project team and opens the Define Project Team UI
     * @param evt event arguments
     */
    private void btnDefineTeamActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDefineTeamActionPerformed
        // get reference to client register
        ProjectRegister projectReg = ProjectRegister.getInstance();

        // check if the project already exists
        if(projectReg.findbyName(txtProjectName.getText(), user) == null)
        {
            // set the project name background colour to the default
            txtProjectName.setBackground(UIManager.getColor( "Panel.background"));
            
            // Warn user that the project will be created
            int answer = JOptionPane.showConfirmDialog(this, "Before you can define the project team the\nproject must be created, confirm you wish to create the project.","Information",JOptionPane.OK_CANCEL_OPTION);

            if (answer == JOptionPane.YES_OPTION) 
            {
                // create new client
                Project project = projectReg.addProject(txtProjectName.getText(), txtDiscTitle.getText(), (Client)cmbClient.getSelectedItem(), (Region)cmbRegion.getSelectedItem(), user, (Date)ftxtCompletionDate.getValue());

                // create Define Project Team Form
                DefineTeamUI frm = new DefineTeamUI(project, user);
                mainform.addForm(frm);
                // remove events
                deregisterEvents();
                // close form
                try {
                    this.setClosed(true);
                } catch (PropertyVetoException ex) {
                    Logger.getLogger(CreateClientUI.class.getName()).log(Level.SEVERE, null, ex);
                }  
            }
        }
        else
        {        
            // highlight the project name as being at fault
            txtProjectName.setBackground(Color.YELLOW);
            
            // explain the project already exists
            JOptionPane.showMessageDialog(this, "A project with this name already exists. \nUnable to create this project again","Information",JOptionPane.ERROR_MESSAGE);
        }
    }//GEN-LAST:event_btnDefineTeamActionPerformed

    /**
     * Creates new project 
     * @param evt event argument
     */
    private void btnCreateProjectActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCreateProjectActionPerformed
        // get reference to client register
        ProjectRegister projectReg = ProjectRegister.getInstance();

        // create new client
        Project created = projectReg.addProject(txtProjectName.getText(), txtDiscTitle.getText(), (Client)cmbClient.getSelectedItem(), (Region)cmbRegion.getSelectedItem(), user, (Date)ftxtCompletionDate.getValue());

        // null returned if project was not created because it already exists
        if (created == null)
        {
            // highlight the project name filed
            txtProjectName.setBackground(Color.YELLOW);
            
            // explain that the project already exists
            JOptionPane.showMessageDialog(this, "A project with this name already exists. \nUnable to create this project again","Information",JOptionPane.ERROR_MESSAGE);
        }
        else
        {
            // set the project name field background to the default colour
            txtProjectName.setBackground(UIManager.getColor( "Panel.background"));
            
            // confirm that the project was created
            JOptionPane.showMessageDialog(this, "Project has been created","Information",JOptionPane.INFORMATION_MESSAGE);
            
            // remove events
            deregisterEvents();
            // close the form
            try {
                this.setClosed(true);
            } catch (PropertyVetoException ex) {
                Logger.getLogger(CreateClientUI.class.getName()).log(Level.SEVERE, null, ex);
            }
        }
    }//GEN-LAST:event_btnCreateProjectActionPerformed

    /**
     * Validates the form and only enables the create buttons when the form is valid
     */
    private void validiateForm()
    {
        // assume state is valid
        boolean invalid = false;
        
        // check project name entered
        if (txtProjectName.getText().length() == 0)
        {
            // invalid form state 
            invalid = true;
        } 
        
        // check disc title entered
        if (txtDiscTitle.getText().length() == 0)
        {
            // invlaid form state
            invalid = true;
        }
        
        // check date is after today
        SimpleDateFormat formatter = new SimpleDateFormat("dd/MM/yyyy");
        String dateInString = ftxtCompletionDate.getText();

        try {

                Date date = formatter.parse(dateInString);

        } catch (ParseException e) {
                invalid = true;
        }
        
        // enable create button if form valid
        if (invalid)
        {
            btnCreateProject.setEnabled(false);
            btnDefineTeam.setEnabled(false);
        }
        else
        {
            btnCreateProject.setEnabled(true);
            btnDefineTeam.setEnabled(true);
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnCreateProject;
    private javax.swing.JButton btnDefineTeam;
    private javax.swing.JComboBox cmbClient;
    private javax.swing.JComboBox cmbRegion;
    private javax.swing.JFormattedTextField ftxtCompletionDate;
    private javax.swing.JLabel lblClient;
    private javax.swing.JLabel lblCompletionDate;
    private javax.swing.JLabel lblDiscRegion;
    private javax.swing.JLabel lblDiscTitle;
    private javax.swing.JLabel lblManager;
    private javax.swing.JLabel lblProjectName;
    private javax.swing.JTextField txtDiscTitle;
    private javax.swing.JTextField txtManager;
    private javax.swing.JTextField txtProjectName;
    // End of variables declaration//GEN-END:variables

    /**
     * Receives update observable events from Client Register (e.g. clients added / removed)
     * @param object Object raising the event
     * @param arg event argument
     */
    @Override
    public void update(Observable object, Object arg) {
        // check if ClientRegister event
        if (object instanceof ClientRegister)
        {
            // cast Object as ClientRegister
            ClientRegister clientReg = (ClientRegister) object;
            
            // reload the avaliable clients into the combo box
            loadClientCombo(clientReg);
        }
    }
}
